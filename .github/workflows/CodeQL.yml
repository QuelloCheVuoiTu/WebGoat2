name: üîç CodeQL Analysis
on:
  push:
    branches: ["main"]
    paths-ignore:
      - '.github/workflows/**'
      - 'sonar-project.properties'
      - '.snyk'
  pull_request:
    branches: ["main"]
    paths-ignore:
      - '.github/workflows/**'
      - 'sonar-project.properties'
      - '.snyk'
  workflow_dispatch:

jobs:
  check-languages:
    name: Detect Languages
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.languages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-detect Project Languages
        id: set-matrix
        run: |
          python3 -c '
          import os
          import json
          mapping = {
              ".py": "python",
              ".js": "javascript", ".ts": "javascript", ".jsx": "javascript", ".tsx": "javascript",
              ".java": "java",
              ".go": "go",
              ".cs": "csharp",
              ".cpp": "cpp", ".c": "cpp", ".h": "cpp", ".cc": "cpp", ".cxx": "cpp",
              ".rb": "ruby",
              ".swift": "swift"
          }
          mode_map = {
              "java": "autobuild", "csharp": "autobuild", "python": "none", 
              "javascript": "none", "ruby": "none", 
              "go": "autobuild", "cpp": "autobuild", "swift": "autobuild"
          }
          found_languages = set()
          try:
              for root, dirs, files in os.walk("."):
                  dirs[:] = [d for d in dirs if not d.startswith(".") and d not in ["node_modules", "dist", "build", "vendor"]]
                  for file in files:
                      ext = os.path.splitext(file)[1].lower()
                      if ext in mapping:
                          found_languages.add(mapping[ext])
          except Exception:
              pass
          matrix_list = []
          sorted_langs = sorted(list(found_languages))
          for lang in sorted_langs:
              mode = mode_map.get(lang, "autobuild")
              matrix_list.append({"language": lang, "build-mode": mode})
          output_json = json.dumps(matrix_list)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"languages={output_json}\n")
          '

  analyze:
    needs: check-languages
    if: ${{ needs.check-languages.outputs.matrix != '[]' && needs.check-languages.outputs.matrix != '' }}
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.check-languages.outputs.matrix) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'
        cache: false

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      continue-on-error: true
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: security-and-quality

    - name: Make build scripts executable
      if: ${{ matrix.build-mode == 'autobuild' }}
      run: chmod +x gradlew mvnw || true

    - name: Autobuild
      if: ${{ matrix.build-mode == 'autobuild' }}
      uses: github/codeql-action/autobuild@v4
      continue-on-error: true

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      continue-on-error: true
      with:
        category: "/language:${{matrix.language}}"
        output: sarif-results

    - name: Generate HTML Report & Check Status
      if: always()
      run: |
        python3 -c "
        import json
        import os
        import sys
        import glob

        fail_on_error = True == True
        exit_code = 0

        sarif_dir = 'sarif-results'
        sarif_path = None
        if os.path.exists(sarif_dir):
            files = glob.glob(os.path.join(sarif_dir, '*.sarif'))
            if files:
                sarif_path = files[0]

        html_path = 'codeql-report-${{matrix.language}}.html'
        html_content = '''<html><head><title>CodeQL Report</title><style>body{font-family:sans-serif;padding:20px;background:#0d1117;color:#c9d1d9} table{border-collapse:collapse;width:100%} th,td{border:1px solid #30363d;padding:8px;text-align:left} th{background:#161b22} .error{color:#ff7b72} .warning{color:#d29922} .critical{color:#ff7b72;font-weight:bold} .high{color:#ff7b72} .medium{color:#d29922} .low{color:#c9d1d9}</style></head><body><h1>CodeQL Analysis Report</h1>'''

        if sarif_path and os.path.exists(sarif_path):
            try:
                with open(sarif_path, 'r') as f:
                    data = json.load(f)

                results = []
                rules_map = {}
                for run in data.get('runs', []):
                    tool_rules = run.get('tool', {}).get('driver', {}).get('rules', [])
                    for r in tool_rules:
                        if 'id' in r: rules_map[r['id']] = r
                    run_results = run.get('results', [])
                    for res in run_results:
                        rule = {}
                        if 'ruleId' in res and res['ruleId'] in rules_map:
                            rule = rules_map[res['ruleId']]
                        elif 'ruleIndex' in res and res['ruleIndex'] < len(tool_rules):
                            rule = tool_rules[res['ruleIndex']]
                        if 'level' not in res:
                            res['level'] = rule.get('defaultConfiguration', {}).get('level', 'warning')
                        props = rule.get('properties', {})
                        sec_sev_str = props.get('security-severity', '0')
                        display_sev = 'Low'
                        try:
                            score = float(sec_sev_str)
                            if score >= 9.0: display_sev = 'Critical'
                            elif score >= 7.0: display_sev = 'High'
                            elif score >= 4.0: display_sev = 'Medium'
                            else: display_sev = 'Low'
                        except:
                            if res['level'] == 'error': display_sev = 'High'
                            else: display_sev = 'Medium'
                        res['_display_sev'] = display_sev
                        results.append(res)

                should_fail = False
                if fail_on_error:
                    for r in results:
                        sev = r.get('_display_sev', 'Low')
                        level = r.get('level', 'warning')
                        if sev in ['Critical', 'High']:
                            should_fail = True
                            print(f'::error::Blocking Pipeline: Found {sev} vulnerability!')
                            break
                        if level == 'error':
                            should_fail = True
                            print('::error::Blocking Pipeline: Found Error level issue!')
                            break

                if should_fail:
                    exit_code = 1

                html_content += '<table><tr><th>Rule</th><th>Severity</th><th>Message</th><th>Location</th></tr>'
                for res in results:
                    rule_id = res.get('ruleId', 'N/A')
                    msg = res.get('message', {}).get('text', '')
                    display_sev = res.get('_display_sev', 'Medium')
                    loc = 'Unknown'
                    if res.get('locations'):
                        loc_obj = res['locations'][0].get('physicalLocation', {})
                        uri = loc_obj.get('artifactLocation', {}).get('uri', '')
                        line = loc_obj.get('region', {}).get('startLine', 0)
                        loc = f'{uri}:{line}'
                    cls = 'medium'
                    if display_sev == 'Critical': cls = 'critical'
                    elif display_sev == 'High': cls = 'high'
                    elif display_sev == 'Low': cls = 'low'
                    html_content += f'<tr class="{cls}"><td>{rule_id}</td><td>{display_sev}</td><td>{msg}</td><td>{loc}</td></tr>'
                html_content += '</table>'

            except Exception as e:
                print(f'Error parsing SARIF: {e}')
                if fail_on_error:
                    exit_code = 1
        else:
            html_content += '<p style="color:#ff7b72"><strong>Analysis Failed:</strong> No SARIF results were produced. The CodeQL scan likely crashed or failed to build the code.</p>'
            print('::warning::CodeQL Analysis failed to produce results.')
            if fail_on_error:
                print('::error::Pipeline blocked because Analysis failed.')
                exit_code = 1
            else:
                print('::notice::Analysis failed but pipeline is non-blocking.')

        html_content += '</body></html>'
        with open(html_path, 'w') as f:
            f.write(html_content)

        sys.exit(exit_code)
        "

    - name: Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codeql-report-${{ matrix.language }}
        path: codeql-report-${{ matrix.language }}.html
